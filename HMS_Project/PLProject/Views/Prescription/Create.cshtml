@model PrescriptionViewModel
@inject IUnitOfWork unitOfWork
@{
	var SubstanceList = unitOfWork.Repository<ActiveSubstance>().GetALL();
	ViewData["Title"] = "Create Presciption";
}
<div class="container mt-5">
	<h2>Insert Items for Presciption</h2>

	<form asp-action="Create" method="post">
		<div id="itemsContainer">
			@for (int i = 0; i < Model.PrescriptionItems.Count; i++)
			{
				<div class="row mb-2 item-row">
					<div class="col">
						<label>Select Active Substance</label>
						<select class="form-select" asp-for="PrescriptionItems[i].ActiveSubstanceId" asp-asp-items="SubstanceItems">
							<option value="">Select Active Substance...</option>
							@foreach (var substance in SubstanceList)
							{
								<option value="@substance.Id">@substance.ActiveSubstancesName</option>
							}
						</select>
					</div>
					<div class="col">
						<label asp-for="PrescriptionItems[i].FullDosage"></label>
						<input asp-for="PrescriptionItems[i].FullDosage" class="form-control" />
					</div>
				</div>
			}
		</div>
		<button type="button" id="addItemButton" class="btn btn-success">+ Add item</button>
		<button type="submit" class="btn btn-primary">Submit</button>
	</form>
</div>
@section Scripts {
	<script>
		$(document).ready(function () {

			// Function to check if the form is valid
			function validateForm() {
				let isValid = true;
				let itemCount = $('#itemsContainer .item-row').length;

				// Check if at least one item is added
				if (itemCount === 0) {
					alert("You must add at least one item.");
					return false;
				}

				// Check each item row
				$('#itemsContainer .item-row').each(function () {
					const substanceSelect = $(this).find('select');
					const dosageInput = $(this).find('input[type="text"]');

					// Check if a substance is selected
					if (substanceSelect.val() === "" || substanceSelect.val() == null) {
						alert("Please select an active substance for all rows.");
						isValid = false;
						return false; // Break out of the loop if invalid
					}

					// Check if dosage is provided
					if (dosageInput.val() === "" || dosageInput.val() == null) {
						alert("Please enter the dosage for all rows.");
						isValid = false;
						return false; // Break out of the loop if invalid
					}
				});

				return isValid;
			}

			// Override form submission
			$('form').submit(function (e) {
				// If form is not valid, prevent submission
				if (!validateForm()) {
					e.preventDefault();
				}
			});

			// Add item functionality
			$('#addItemButton').click(function () {
				var itemCount = $('#itemsContainer .item-row').length;
				var newRow = `
											<div class="row mb-2 item-row">
												<div class="col">
													<label>Select Active Substance:</label>
													<select class="form-select" name="PrescriptionItems[${itemCount}].ActiveSubstanceId">
														<option value="">Select Active Substance...</option>
		@foreach (var substance in SubstanceList)
		{
																		<option value="@substance.Id">@substance.ActiveSubstancesName</option>
		}
													</select>
												</div>
												<div class="col">
													<label>Full Dosage:</label>
													 <input type="text" class="form-control" name="PrescriptionItems[${itemCount}].FullDosage" />
												</div>
												<div class="col-auto align-self-end">
													<button type="button" class="btn btn-danger remove-item">-</button>
												</div>
											</div>
										`;
				$('#itemsContainer').append(newRow);
			});

			// Remove item functionality
			$(document).on('click', '.remove-item', function () {
				$(this).closest('.item-row').remove();
			});
		});
	</script>
}


